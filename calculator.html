<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>حاسبة المعدل | USTHB – Data Science</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
      :root {
        --primary: #4f46e5;
        --primary-hover: #4338ca;
        --secondary: #64748b;
        --bg-body: #f1f5f9;
        --bg-card: #ffffff;
        --text-main: #1e293b;
        --text-light: #64748b;
        --border: #e2e8f0;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Tajawal", sans-serif;
      }

      body {
        background-color: var(--bg-body);
        color: var(--text-main);
        padding-bottom: 100px; /* مساحة للشريط السفلي */
        line-height: 1.6;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }

      /* --- Header --- */
      header {
        text-align: center;
        margin-bottom: 30px;
      }

      header h1 {
        font-weight: 800;
        color: var(--primary);
        font-size: 2rem;
        margin-bottom: 5px;
      }

      header p {
        color: var(--text-light);
        font-size: 1.1rem;
      }

      .hero-badges {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .badge {
        background: #e0e7ff;
        color: var(--primary);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      /* --- Year Selector --- */
      .year-selector {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 30px;
        background: #fff;
        padding: 10px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        flex-wrap: wrap;
      }

      .year-btn {
        background: transparent;
        border: 2px solid transparent;
        padding: 8px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        color: var(--secondary);
        transition: all 0.3s ease;
      }

      .year-btn:hover {
        background: #f8fafc;
        color: var(--primary);
      }

      .year-btn.active {
        background: var(--primary);
        color: #fff;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      }

      /* --- Cards & Tables --- */
      .semester-card {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
      }

      .semester-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px dashed var(--border);
      }

      .semester-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .semester-avg-badge {
        background: #f1f5f9;
        padding: 5px 15px;
        border-radius: 8px;
        font-weight: 800;
        font-size: 1.1rem;
        color: var(--text-light);
      }

      .table-container {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px; /* مسافة بين الصفوف */
      }

      th {
        text-align: right;
        font-size: 0.9rem;
        color: var(--text-light);
        font-weight: 600;
        padding: 0 10px;
      }

      td {
        vertical-align: middle;
        padding: 0 4px;
      }

      /* --- Inputs Styling (تحسين مساحة الكتابة) --- */
      input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: #f8fafc;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-main);
        transition: all 0.2s;
        outline: none;
        /* تحسين مظهر الأرقام */
        -moz-appearance: textfield;
      }

      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      input:focus {
        border-color: var(--primary);
        background: #fff;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .inp-name {
        text-align: right;
        background: transparent;
        border: none;
        border-bottom: 1px solid var(--border);
        border-radius: 0;
        padding-left: 0;
        padding-right: 0;
      }
      .inp-name:focus {
        border-bottom-color: var(--primary);
        box-shadow: none;
      }

      .inp-grade, .inp-coeff, .inp-credit {
        text-align: center;
        /* هذا يضمن مساحة كافية للأرقام */
        min-width: 60px; 
      }

      /* تمييز المعدل المحسوب */
      .mod-avg {
        display: block;
        text-align: center;
        font-weight: 700;
        padding: 6px;
        border-radius: 6px;
        background: #f1f5f9;
      }

      /* --- Buttons --- */
      .btn-add {
        width: 100%;
        padding: 12px;
        margin-top: 15px;
        background: #fff;
        border: 2px dashed var(--border);
        color: var(--secondary);
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
      }

      .btn-add:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: #fdfeff;
      }

      .btn-del {
        background: #fee2e2;
        color: var(--danger);
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
      }
      .btn-del:hover {
        background: var(--danger);
        color: #fff;
      }

      .btn-reset {
        display: block;
        margin: 40px auto;
        background: transparent;
        color: var(--text-light);
        border: none;
        font-size: 0.9rem;
        cursor: pointer;
        text-decoration: underline;
      }
      .btn-reset:hover {
        color: var(--danger);
      }

      /* --- Footer --- */
      footer {
        text-align: center;
        color: var(--text-light);
        font-size: 0.85rem;
        margin-top: 20px;
        opacity: 0.7;
      }

      /* --- Results Bar --- */
      .results-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-top: 1px solid var(--border);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        z-index: 1000;
      }

      .res-group {
        display: flex;
        gap: 30px;
      }

      .res-item {
        display: flex;
        flex-direction: column;
      }

      .res-label {
        font-size: 0.75rem;
        color: var(--text-light);
        margin-bottom: 2px;
      }

      .res-value {
        font-size: 1.5rem;
        font-weight: 800;
        line-height: 1;
      }

      .credits-mini-bar {
        width: 100px;
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        margin-top: 4px;
        overflow: hidden;
      }
      .credits-fill {
        height: 100%;
        background: var(--primary);
        width: 0%;
        transition: width 0.5s ease;
      }

      .res-decision {
        font-size: 1.1rem;
        font-weight: 700;
        padding: 8px 20px;
        border-radius: 30px;
        background: #f1f5f9;
        color: var(--secondary);
      }

      .status-success {
        background: #d1fae5;
        color: #065f46;
      }
      .status-fail {
        background: #fee2e2;
        color: #991b1b;
      }
      .status-debt {
        background: #ffedd5;
        color: #9a3412;
      }

      /* --- Mobile Responsive --- */
      @media (max-width: 600px) {
        .col-hide-mobile {
          display: none;
        }
        
        .year-btn {
          padding: 6px 16px;
          font-size: 0.9rem;
        }

        .results-bar {
          flex-direction: column;
          gap: 15px;
          padding: 15px;
        }
        
        .res-group {
          width: 100%;
          justify-content: space-around;
        }
        
        #final-decision {
          width: 100%;
          text-align: center;
        }

        th, td {
            padding: 0 2px;
        }

        /* تحسين عرض المدخلات في الموبايل */
        .inp-grade {
            padding: 8px 4px;
            font-size: 0.95rem;
        }
      }
      
      /* SweetAlert Customization */
      .swal-rounded {
        border-radius: 20px !important;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header>
        <h1><i class="fa-solid fa-calculator"></i> حاسبة المعدل</h1>
        <p>تخصص علوم البيانات – USTHB</p>
        <div class="hero-badges">
          <span class="badge"
            ><i class="fa-solid fa-graduation-cap"></i> USTHB</span
          >
          <span class="badge"
            ><i class="fa-solid fa-database"></i> Data Science</span
          >
          <span class="badge"
            ><i class="fa-solid fa-shield-halved"></i> نظام LMD</span
          >
        </div>
      </header>

      <div class="year-selector">
        <button class="year-btn" onclick="confirmLoadTemplate('L1')">L1</button>
        <button class="year-btn" onclick="confirmLoadTemplate('L2')">L2</button>
        <button class="year-btn" onclick="confirmLoadTemplate('L3')">L3</button>
        <button class="year-btn" onclick="confirmLoadTemplate('M1')">M1</button>
        <button class="year-btn" onclick="confirmLoadTemplate('M2')">M2</button>
      </div>

      <div class="semesters-grid">
        <div class="semester-card">
          <div class="semester-header">
            <span class="semester-title" id="title-s1">
              <i class="fa-regular fa-calendar"></i> السداسي الفردي
            </span>
            <span class="semester-avg-badge" id="avg-s1">0.00</span>
          </div>

          <div class="table-container">
            <table id="table-s1">
              <thead>
                <tr>
                  <th style="width: 35%">المادة</th>
                  <th class="col-hide-mobile" style="width: 12%">المعامل</th>
                  <th class="col-hide-mobile" style="width: 12%">الرصيد</th>
                  <th style="width: 15%">TD</th>
                  <th style="width: 15%">Exam</th>
                  <th style="width: 10%">المعدل</th>
                  <th style="width: 5%"></th>
                </tr>
              </thead>
              <tbody>
                </tbody>
            </table>
          </div>

          <button class="btn-add" onclick="addRow('table-s1')">
            <i class="fa-solid fa-plus"></i> إضافة مادة
          </button>
        </div>

        <div class="semester-card">
          <div class="semester-header">
            <span class="semester-title" id="title-s2">
              <i class="fa-regular fa-calendar-check"></i> السداسي الزوجي
            </span>
            <span class="semester-avg-badge" id="avg-s2">0.00</span>
          </div>

          <div class="table-container">
            <table id="table-s2">
              <thead>
                <tr>
                  <th style="width: 35%">المادة</th>
                  <th class="col-hide-mobile" style="width: 12%">المعامل</th>
                  <th class="col-hide-mobile" style="width: 12%">الرصيد</th>
                  <th style="width: 15%">TD</th>
                  <th style="width: 15%">Exam</th>
                  <th style="width: 10%">المعدل</th>
                  <th style="width: 5%"></th>
                </tr>
              </thead>
              <tbody>
                </tbody>
            </table>
          </div>

          <button class="btn-add" onclick="addRow('table-s2')">
            <i class="fa-solid fa-plus"></i> إضافة مادة
          </button>
        </div>
      </div>

      <button class="btn-reset" onclick="resetAll()">
        <i class="fa-solid fa-trash"></i> تفريغ كل البيانات وحذفها
      </button>

      <footer>© 2025 – Developed By Addar Mohamed Akram</footer>
    </div>

    <div class="results-bar">
      <div class="res-group">
        <div class="res-item">
          <span class="res-label">المعدل السنوي</span>
          <span class="res-value" id="final-avg">0.00</span>
        </div>

        <div class="res-item">
          <span class="res-label"
            >الرصيد (<span id="final-credits">0</span>/60)</span
          >
          <div class="credits-mini-bar">
            <div class="credits-fill" id="credits-bar"></div>
          </div>
        </div>
      </div>

      <div id="final-decision" class="res-decision">
        <i class="fa-solid fa-minus"></i> --
      </div>
    </div>

    <script>
      const CURRICULUM = {
        L1: {
          s1: [
            { name: "Analyse 1", coeff: 5, credit: 7 },
            { name: "Algèbre 1", coeff: 4, credit: 6 },
            { name: "Algo & Struct Données 1", coeff: 3, credit: 6 },
            { name: "Statistique 1", coeff: 3, credit: 6 },
            { name: "TIC 1", coeff: 2, credit: 3 },
            { name: "Anglais 1", coeff: 1, credit: 2 },
          ],
          s2: [
            { name: "Analyse 2", coeff: 5, credit: 7 },
            { name: "Algèbre 2", coeff: 4, credit: 6 },
            { name: "Algo & Struct Données 2", coeff: 3, credit: 6 },
            { name: "Statistique 2", coeff: 3, credit: 6 },
            { name: "Outils Prog Math", coeff: 2, credit: 3 },
            { name: "Anglais 2", coeff: 1, credit: 2 },
          ],
        },
        L2: {
          s1: [
            { name: "Analyse 3", coeff: 5, credit: 7 },
            { name: "Topologie", coeff: 3, credit: 5 },
            { name: "Algèbre 3", coeff: 2, credit: 4 },
            { name: "Probabilités 1", coeff: 3, credit: 5 },
            { name: "Prog Orientée Objet", coeff: 2, credit: 3 },
            { name: "Complexité", coeff: 2, credit: 4 },
            { name: "Anglais 3", coeff: 1, credit: 2 },
          ],
          s2: [
            { name: "Analyse 4", coeff: 4, credit: 7 },
            { name: "Algèbre 4", coeff: 3, credit: 4 },
            { name: "Probabilités 2", coeff: 3, credit: 4 },
            { name: "Bases de Données", coeff: 2, credit: 4 },
            { name: "Prog Python", coeff: 2, credit: 4 },
            { name: "Recherche Opé 1", coeff: 3, credit: 5 },
            { name: "Anglais 4", coeff: 1, credit: 2 },
          ],
        },
        L3: {
          s1: [
            { name: "Statistique", coeff: 4, credit: 6 },
            { name: "Data Mining 1", coeff: 3, credit: 6 },
            { name: "Analyse Numérique", coeff: 3, credit: 5 },
            { name: "Optimisation Non Linéaire", coeff: 3, credit: 5 },
            { name: "Modélisation Etudes Cas", coeff: 3, credit: 5 },
            { name: "Intro Management", coeff: 1, credit: 2 },
          ],
          s2: [
            { name: "Processus Aléatoires", coeff: 4, credit: 6 },
            { name: "Data Mining 2", coeff: 4, credit: 6 },
            { name: "Recherche Opé 2", coeff: 2, credit: 4 },
            { name: "Sondages et Enquêtes", coeff: 2, credit: 4 },
            { name: "Gestion de Projets", coeff: 2, credit: 3 },
            { name: "Théorie de l'Info", coeff: 2, credit: 3 },
            { name: "Stage", coeff: 2, credit: 4 },
          ],
        },
        M1: {
          s1: [
            { name: "Modèles Linéaires", coeff: 3, credit: 5 },
            { name: "Séries Chronologiques", coeff: 3, credit: 5 },
            { name: "Inférence Bayésienne", coeff: 2, credit: 4 },
            { name: "Simulation", coeff: 2, credit: 4 },
            { name: "Data Warehouse & OLAP", coeff: 3, credit: 5 },
            { name: "Analyse Multicritère", coeff: 3, credit: 4 },
            { name: "Intro Sécurité Info", coeff: 2, credit: 3 },
          ],
          s2: [
            { name: "Estimation Non Param", coeff: 3, credit: 6 },
            { name: "Données Catégorielles", coeff: 2, credit: 4 },
            { name: "Machine Learning", coeff: 2, credit: 4 },
            { name: "BDD Réparties", coeff: 2, credit: 4 },
            { name: "Prog & Logiciels SD", coeff: 3, credit: 4 },
            { name: "Machine Learning Avancé", coeff: 4, credit: 8 },
            { name: "Modèles Graphiques", coeff: 3, credit: 6 },
          ],
        },
        M2: {
          s1: [
            { name: "Théorie des Codes", coeff: 3, credit: 5 },
            { name: "Arbres de Décision", coeff: 3, credit: 4 },
            { name: "Finance", coeff: 2, credit: 3 },
            { name: "Matière Optionnelle 1", coeff: 2, credit: 4 },
            { name: "Matière Optionnelle 2", coeff: 2, credit: 4 },
          ],
          s2: [{ name: "Projet Fin d'Études (PFE)", coeff: 16, credit: 30 }],
        },
      };

      // Toast notification configuration
      const Toast = Swal.mixin({
        toast: true,
        position: "top-end",
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true,
        didOpen: (toast) => {
          toast.addEventListener("mouseenter", Swal.stopTimer);
          toast.addEventListener("mouseleave", Swal.resumeTimer);
        },
      });

      window.onload = function () {
        const savedData = localStorage.getItem("usthb_ds_design_v2");
        if (savedData) {
          const parsed = JSON.parse(savedData);
          restoreData(parsed);
        } else {
          loadTemplate("L1", false);
        }
      };

      function confirmLoadTemplate(level) {
        Swal.fire({
          title: `تحميل مواد سنة ${level}؟`,
          text: "سيتم استبدال الجدول الحالي وحذف النقاط المدخلة.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#4f46e5",
          cancelButtonColor: "#94a3b8",
          confirmButtonText: "نعم، تحميل",
          cancelButtonText: "إلغاء",
          customClass: { popup: "swal-rounded" },
        }).then((result) => {
          if (result.isConfirmed) {
            loadTemplate(level);
            Toast.fire({
              icon: "success",
              title: `تم تحميل ${level} بنجاح`,
            });
          }
        });
      }

      function loadTemplate(level, save = true) {
        // Toggle active class on buttons
        document
          .querySelectorAll(".year-btn")
          .forEach((b) => b.classList.remove("active"));
        const activeBtn = Array.from(
          document.querySelectorAll(".year-btn")
        ).find((b) => b.textContent.includes(level));
        if (activeBtn) activeBtn.classList.add("active");

        const data = CURRICULUM[level];
        document.querySelector("#table-s1 tbody").innerHTML = "";
        document.querySelector("#table-s2 tbody").innerHTML = "";

        data.s1.forEach((m) => addRow("table-s1", m));
        data.s2.forEach((m) => addRow("table-s2", m));

        updateHeaders(level);
        calculateAll(false);
        if (save) saveData();
      }

      function updateHeaders(level) {
        let titles = {
          L1: ["السداسي 1", "السداسي 2"],
          L2: ["السداسي 3", "السداسي 4"],
          L3: ["السداسي 5", "السداسي 6"],
          M1: ["السداسي 1 (M1)", "السداسي 2 (M1)"],
          M2: ["السداسي 3 (M2)", "السداسي 4 (M2)"],
        };
        document.getElementById(
          "title-s1"
        ).innerHTML = `<i class="fa-regular fa-calendar"></i> ${titles[level][0]}`;
        document.getElementById(
          "title-s2"
        ).innerHTML = `<i class="fa-regular fa-calendar-check"></i> ${titles[level][1]}`;
      }

      function addRow(tableId, data = {}) {
        const tbody = document.querySelector(`#${tableId} tbody`);
        const row = tbody.insertRow();

        const name = data.name || "";
        const coeff = data.coeff || 1;
        const credit = data.credit || 1;
        const td = data.td || "";
        const exam = data.exam || "";

        row.innerHTML = `
          <td><input type="text" class="inp-name" value="${name}" placeholder="المادة..."></td>
          <td class="col-hide-mobile"><input type="number" class="inp-coeff" value="${coeff}" min="1" oninput="calculateAll()"></td>
          <td class="col-hide-mobile"><input type="number" class="inp-credit" value="${credit}" min="1" oninput="calculateAll()"></td>
          <td><input type="number" class="inp-grade inp-td" value="${td}" min="0" max="20" placeholder="-" oninput="validateInput(this); calculateAll()"></td>
          <td><input type="number" class="inp-grade inp-exam" value="${exam}" min="0" max="20" placeholder="-" oninput="validateInput(this); calculateAll()"></td>
          <td><span class="mod-avg">0.00</span></td>
          <td><button class="btn-del" onclick="deleteRow(this)"><i class="fa-solid fa-xmark"></i></button></td>
      `;
      }

      function validateInput(input) {
        if (input.value > 20) input.value = 20;
        if (input.value < 0) input.value = 0;
      }

      function deleteRow(btn) {
        btn.closest("tr").remove();
        calculateAll();
      }

      let hasCelebrated = false;

      function calculateAll(allowConfetti = true) {
        const s1 = calculateSemester("table-s1");
        const s2 = calculateSemester("table-s2");

        updateBadge("avg-s1", s1.avg);
        updateBadge("avg-s2", s2.avg);

        const annualAvg = (s1.avg + s2.avg) / 2;
        const avgEl = document.getElementById("final-avg");
        avgEl.innerText = annualAvg.toFixed(2);

        // Annual Average Color
        if (annualAvg >= 10) avgEl.style.color = "var(--success)";
        else avgEl.style.color = "var(--danger)";

        // Credits Logic with Compensation
        let creditsS1 = s1.avg >= 10 ? 30 : s1.credits;
        let creditsS2 = s2.avg >= 10 ? 30 : s2.credits;
        if (annualAvg >= 10) {
          creditsS1 = 30;
          creditsS2 = 30;
        }
        const totalCredits = Math.min(60, creditsS1 + creditsS2);

        document.getElementById("final-credits").innerText = totalCredits;
        const percent = (totalCredits / 60) * 100;
        document.getElementById("credits-bar").style.width = `${percent}%`;

        // Decision Logic
        const decisionEl = document.getElementById("final-decision");
        decisionEl.className = "res-decision"; // reset classes

        if (annualAvg >= 10) {
          decisionEl.innerHTML =
            '<i class="fa-solid fa-check-circle"></i> ناجح';
          decisionEl.classList.add("status-success");

          if (allowConfetti && !hasCelebrated) {
            confetti({
              particleCount: 150,
              spread: 80,
              origin: { y: 0.7 },
              colors: ["#10b981", "#3b82f6", "#f59e0b"],
            });
            hasCelebrated = true;
          }
        } else if (totalCredits >= 30) {
          decisionEl.innerHTML =
            '<i class="fa-solid fa-exclamation-circle"></i> ديون';
          decisionEl.classList.add("status-debt");
          hasCelebrated = false;
        } else {
          decisionEl.innerHTML =
            '<i class="fa-solid fa-times-circle"></i> راسب';
          decisionEl.classList.add("status-fail");
          hasCelebrated = false;
        }

        saveData();
      }

      function updateBadge(id, val) {
        const el = document.getElementById(id);
        el.innerText = val.toFixed(2);
        if (val >= 10) {
          el.style.color = "var(--success)";
          el.style.background = "#d1fae5";
        } else {
          el.style.color = "var(--danger)";
          el.style.background = "#fee2e2";
        }
      }

      function calculateSemester(tableId) {
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        let totalPoints = 0;
        let totalCoeff = 0;
        let acquiredCredits = 0;

        rows.forEach((row) => {
          const coeff = parseFloat(row.querySelector(".inp-coeff").value) || 0;
          const credit =
            parseFloat(row.querySelector(".inp-credit").value) || 0;
          const tdVal = row.querySelector(".inp-td").value;
          const examVal = row.querySelector(".inp-exam").value;
          const exam = parseFloat(examVal) || 0;

          let avg = 0;
          if (tdVal === "") {
            avg = exam;
          } else {
            const td = parseFloat(tdVal) || 0;
            avg = exam * 0.6 + td * 0.4; // 60% Exam, 40% TD
          }

          const avgSpan = row.querySelector(".mod-avg");
          avgSpan.innerText = avg.toFixed(2);

          if (avg >= 10) {
            avgSpan.style.color = "var(--success)";
            avgSpan.style.background = "#d1fae5";
          } else {
            avgSpan.style.color = "var(--danger)";
            avgSpan.style.background = "#fee2e2";
          }

          totalPoints += avg * coeff;
          totalCoeff += coeff;
          if (avg >= 10) acquiredCredits += credit;
        });

        const semesterAvg = totalCoeff > 0 ? totalPoints / totalCoeff : 0;
        return { avg: semesterAvg, credits: acquiredCredits };
      }

      function saveData() {
        const data = {
          s1: getTableData("table-s1"),
          s2: getTableData("table-s2"),
          activeYear:
            document.querySelector(".year-btn.active")?.innerText || "L1",
        };
        localStorage.setItem("usthb_ds_design_v2", JSON.stringify(data));
      }

      function getTableData(tableId) {
        return Array.from(
          document.querySelectorAll(`#${tableId} tbody tr`)
        ).map((row) => ({
          name: row.querySelector(".inp-name").value,
          coeff: row.querySelector(".inp-coeff").value,
          credit: row.querySelector(".inp-credit").value,
          td: row.querySelector(".inp-td").value,
          exam: row.querySelector(".inp-exam").value,
        }));
      }

      function restoreData(data) {
        document.querySelector("#table-s1 tbody").innerHTML = "";
        document.querySelector("#table-s2 tbody").innerHTML = "";
        data.s1.forEach((m) => addRow("table-s1", m));
        data.s2.forEach((m) => addRow("table-s2", m));

        if (data.activeYear) {
          document.querySelectorAll(".year-btn").forEach((b) => {
            if (b.innerText === data.activeYear) b.classList.add("active");
            else b.classList.remove("active");
          });
          updateHeaders(data.activeYear);
        }
        calculateAll(false);
      }

      function resetAll() {
        Swal.fire({
          title: "هل أنت متأكد؟",
          text: "سيتم حذف جميع البيانات بشكل نهائي.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#ef4444",
          cancelButtonColor: "#94a3b8",
          confirmButtonText: "نعم، حذف",
          cancelButtonText: "إلغاء",
          customClass: { popup: "swal-rounded" },
        }).then((result) => {
          if (result.isConfirmed) {
            localStorage.removeItem("usthb_ds_design_v2");
            location.reload();
          }
        });
      }
    </script>
  </body>
</html>
